<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alunos - Olimp√≠ada IDB</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="dashboard.html" class="sidebar-logo">
          <div class="sidebar-logo-icon">üèÜ</div>
          <span>Olimp√≠ada IDB</span>
        </a>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>
          <a href="dashboard.html" class="nav-item">
            <span class="nav-icon">üìä</span>
            <span>Dashboard</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Olimp√≠adas</div>
          <a href="olimpiadas.html" class="nav-item">
            <span class="nav-icon">üèÖ</span>
            <span>Olimp√≠adas</span>
          </a>
          <a href="inscricoes.html" class="nav-item">
            <span class="nav-icon">üìù</span>
            <span>Inscri√ß√µes</span>
          </a>
          <a href="resultados.html" class="nav-item">
            <span class="nav-icon">üìà</span>
            <span>Resultados</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Cadastros</div>
          <a href="alunos.html" class="nav-item active">
            <span class="nav-icon">üë•</span>
            <span>Alunos</span>
          </a>
          <a href="turmas.html" class="nav-item">
            <span class="nav-icon">üéì</span>
            <span>Turmas</span>
          </a>
          <a href="series.html" class="nav-item">
            <span class="nav-icon">üìö</span>
            <span>S√©ries</span>
          </a>
          <a href="anos-letivos.html" class="nav-item">
            <span class="nav-icon">üìÖ</span>
            <span>Anos Letivos</span>
          </a>
          <a href="filiais.html" class="nav-item">
            <span class="nav-icon">üè´</span>
            <span>Filiais</span>
          </a>
          <a href="tipos-correcao.html" class="nav-item">
            <span class="nav-icon">‚úÖ</span>
            <span>Tipos de Corre√ß√£o</span>
          </a>
          <a href="locais-aplicacao.html" class="nav-item">
            <span class="nav-icon">üìç</span>
            <span>Locais de Aplica√ß√£o</span>
          </a>
          <a href="tipos-pagamento.html" class="nav-item">
            <span class="nav-icon">üí∞</span>
            <span>Tipos de Pagamento</span>
          </a>
        </div>

        <div class="nav-section" id="adminSection" style="display: none;">
          <div class="nav-section-title">Administra√ß√£o</div>
          <a href="usuarios.html" class="nav-item">
            <span class="nav-icon">üë§</span>
            <span>Usu√°rios</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Rankings</div>
          <a href="medalhistas.html" class="nav-item">
            <span class="nav-icon">ü•á</span>
            <span>Medalhistas</span>
          </a>
          <a href="rankings.html" class="nav-item">
            <span class="nav-icon">üìä</span>
            <span>Rankings</span>
          </a>
        </div>

        <div class="nav-section" id="adminSection" style="display: none;">
          <div class="nav-section-title">Administra√ß√£o</div>
          <a href="usuarios.html" class="nav-item">
            <span class="nav-icon">üë§</span>
            <span>Usu√°rios</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Topbar -->
      <header class="topbar">
        <div class="topbar-left">
          <h1 class="page-title">Alunos</h1>
          <div class="breadcrumb">
            <span>Cadastros</span>
            <span class="breadcrumb-separator">/</span>
            <span>Alunos</span>
          </div>
        </div>
        <div class="topbar-right">
          <div class="user-menu">
            <div class="user-avatar" id="userAvatar">M</div>
            <div class="user-info">
              <div class="user-name" id="userName">Carregando...</div>
              <div class="user-role" id="userRole">Administrador</div>
            </div>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="logout()">Sair</button>
        </div>
      </header>

      <!-- Content -->
      <div class="content">
        <!-- Barra de a√ß√µes -->
        <div class="flex-between mb-3">
          <div class="flex gap-2">
            <input 
              type="search" 
              class="form-input" 
              placeholder="Buscar aluno por nome ou RA..." 
              id="searchInput"
              style="width: 300px;"
            >
            <select class="form-select" id="filterTurma" style="width: 200px;">
              <option value="">Todas as turmas</option>
            </select>
            <select class="form-select" id="filterSituacao" style="width: 150px;">
              <option value="">Todas as situa√ß√µes</option>
              <option value="Matriculado">Matriculado</option>
              <option value="Cancelado">Cancelado</option>
              <option value="Transferido">Transferido</option>
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="novoAluno()">
            ‚ûï Novo Aluno
          </button>
        </div>

        <!-- Estat√≠sticas r√°pidas -->
        <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;">
          <div class="stat-card">
            <div class="stat-icon blue">üë•</div>
            <div class="stat-info">
              <div class="stat-label">Total de Alunos</div>
              <div class="stat-value" id="totalAlunos">-</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon green">‚úì</div>
            <div class="stat-info">
              <div class="stat-label">Alunos Ativos</div>
              <div class="stat-value" id="alunosAtivos">-</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon orange">üìù</div>
            <div class="stat-info">
              <div class="stat-label">Inscritos em Olimp√≠adas</div>
              <div class="stat-value" id="alunosInscritos">-</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon purple">üèÖ</div>
            <div class="stat-info">
              <div class="stat-label">Medalhistas</div>
              <div class="stat-value" id="medalhistas">-</div>
            </div>
          </div>
        </div>

        <!-- Tabela de alunos -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Lista de Alunos</h2>
            <div class="flex gap-2">
              <button class="btn btn-sm btn-outline" onclick="exportarAlunos()">
                üìä Exportar
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table class="table">
                <thead>
                  <tr>
                    <th>RA</th>
                    <th>Nome</th>
                    <th>Turma</th>
                    <th>Filial</th>
                    <th>Situa√ß√£o</th>
                    <th>Tipo</th>
                    <th style="width: 120px;">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="alunosTable">
                  <tr>
                    <td colspan="7" class="text-center">Carregando...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer">
            <div class="flex-between">
              <div id="paginationInfo">Mostrando 0 de 0 alunos</div>
              <div id="paginationControls"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../js/app.js"></script>
  <script>
    const token = checkAuth();
    const user = getUser();

    if (user) {
      document.getElementById('userName').textContent = user.nome || user.email;
      document.getElementById('userAvatar').textContent = (user.nome || user.email).charAt(0).toUpperCase();
      const nivelMap = { 1: 'Administrador', 2: 'Professor', 3: 'Aluno', 4: 'Respons√°vel' };
      document.getElementById('userRole').textContent = nivelMap[user.nivelAcesso] || 'Usu√°rio';
    }

    // Mostrar se√ß√£o de administra√ß√£o apenas para administradores
    if (user.nivel_acesso === 1) {
      document.getElementById('adminSection').style.display = 'block';
    }

    let alunos = [];
    let turmas = [];
    let currentPage = 1;
    let totalPages = 1;
    let totalAlunos = 0;

    async function loadAlunos(page = 1) {
      try {
        const searchTerm = document.getElementById('searchInput').value;
        const filterTurma = document.getElementById('filterTurma').value;
        const filterSituacao = document.getElementById('filterSituacao').value;
        
        let url = `/alunos?page=${page}&limit=50`;
        if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;
        if (filterTurma) url += `&idTurma=${filterTurma}`;
        if (filterSituacao) url += `&situacao=${filterSituacao}`;
        
        const response = await fetchAuth(url);
        // console.log('Response alunos:', response);
        // console.log('Data array:', response.data);
        // console.log('Total:', response.total);
        // console.log('Pagination:', response.pagination);
        
        alunos = response.data || [];
        totalAlunos = response.total || 0;
        currentPage = response.pagination?.page || 1;
        totalPages = response.pagination?.totalPages || 1;
        
        // console.log('Ap√≥s atribui√ß√£o - alunos.length:', alunos.length);
        // console.log('Ap√≥s atribui√ß√£o - totalAlunos:', totalAlunos);
        // console.log('Ap√≥s atribui√ß√£o - currentPage:', currentPage);
        // console.log('Ap√≥s atribui√ß√£o - totalPages:', totalPages);
        
        renderAlunos();
        renderPagination();
        updateStats();
      } catch (error) {
        console.error('Erro ao carregar alunos:', error);
        showNotification('Erro ao carregar alunos', 'error');
      }
    }

    async function loadTurmas() {
      try {
        const response = await fetchAuth('/turmas');
        const { data } = response;
        turmas = data || [];
        
        const select = document.getElementById('filterTurma');
        select.innerHTML = '<option value="">Todas as turmas</option>' +
          turmas.map(t => `<option value="${t.idTurma}">${t.turma} - ${t.serie}</option>`).join('');
      } catch (error) {
        console.error('Erro ao carregar turmas:', error);
      }
    }

    function renderAlunos() {
      const tbody = document.getElementById('alunosTable');

      if (alunos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum aluno encontrado</td></tr>';
        document.getElementById('paginationInfo').textContent = 'Nenhum aluno encontrado';
        return;
      }

      tbody.innerHTML = alunos.map(a => {
        const situacaoMap = {
          'ativo': '<span class="badge badge-success">Ativo</span>',
          'Matriculado': '<span class="badge badge-success">Matriculado</span>',
          'inativo': '<span class="badge badge-danger">Inativo</span>',
          'Cancelado': '<span class="badge badge-danger">Cancelado</span>',
          'transferido': '<span class="badge badge-warning">Transferido</span>',
          'Transferido': '<span class="badge badge-warning">Transferido</span>'
        };

        return `
          <tr>
            <td><strong>${a.ra || '-'}</strong></td>
            <td>${a.nome_pessoa || '-'}</td>
            <td>${a.turma_nome ? `${a.turma_nome} (${a.serie_nome})` : '-'}</td>
            <td>${a.filial_nome || '-'}</td>
            <td>${situacaoMap[a.situacao] || a.situacao}</td>
            <td>${a.tipo || '-'}</td>
            <td>
              <div class="flex gap-1">
                <button class="btn btn-sm btn-primary" onclick="verAluno(${a.idAluno})" title="Ver detalhes">üëÅÔ∏è</button>
                <button class="btn btn-sm btn-secondary" onclick="editarAluno(${a.idAluno})" title="Editar">‚úèÔ∏è</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      if (totalAlunos > 0) {
        const start = (currentPage - 1) * 50 + 1;
        const end = Math.min(currentPage * 50, totalAlunos);
        document.getElementById('paginationInfo').textContent = `Mostrando ${start}-${end} de ${totalAlunos} alunos`;
      } else {
        document.getElementById('paginationInfo').textContent = 'Nenhum aluno encontrado';
      }
    }

    function renderPagination() {
      const container = document.getElementById('paginationControls');
      
      console.log('renderPagination - totalPages:', totalPages, 'currentPage:', currentPage);
      
      if (totalPages <= 1) {
        console.log('totalPages <= 1, n√£o renderizando bot√µes');
        container.innerHTML = '';
        return;
      }

      console.log('Renderizando bot√µes de pagina√ß√£o');
      let html = '<div class="flex gap-1">';
      
      // Bot√£o anterior
      html += `<button class="btn btn-sm btn-outline" ${currentPage === 1 ? 'disabled' : ''} onclick="loadAlunos(${currentPage - 1})">‚Äπ Anterior</button>`;
      
      // P√°ginas
      const maxButtons = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxButtons - 1);
      
      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline'}" onclick="loadAlunos(${i})">${i}</button>`;
      }
      
      // Bot√£o pr√≥ximo
      html += `<button class="btn btn-sm btn-outline" ${currentPage === totalPages ? 'disabled' : ''} onclick="loadAlunos(${currentPage + 1})">Pr√≥ximo ‚Ä∫</button>`;
      
      html += '</div>';
      container.innerHTML = html;
    }

    function updateStats() {
      document.getElementById('totalAlunos').textContent = totalAlunos;
      document.getElementById('alunosAtivos').textContent = alunos.filter(a => a.situacao === 'Matriculado' || a.situacao === 'ativo').length;
      document.getElementById('alunosInscritos').textContent = '0'; // TODO: Implementar
      document.getElementById('medalhistas').textContent = '0'; // TODO: Implementar
    }

    function verAluno(id) {
      const aluno = alunos.find(a => a.idAluno === id);
      if (!aluno) return;
      
      alert(`Aluno: ${aluno.nome_pessoa}\nRA: ${aluno.ra}\nTurma: ${aluno.turma_nome}\nS√©rie: ${aluno.serie_nome}\nFilial: ${aluno.filial_nome}\nSitua√ß√£o: ${aluno.situacao}`);
    }

    function editarAluno(id) {
      showNotification('Funcionalidade de edi√ß√£o em desenvolvimento', 'info');
    }

    function novoAluno() {
      showNotification('Modal de cadastro de aluno em desenvolvimento', 'info');
    }

    function exportarAlunos() {
      showNotification('Exporta√ß√£o em desenvolvimento', 'info');
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', debounce(() => loadAlunos(1), 500));
    document.getElementById('filterTurma').addEventListener('change', () => loadAlunos(1));
    document.getElementById('filterSituacao').addEventListener('change', () => loadAlunos(1));

    // Carregar dados
    loadAlunos();
    loadTurmas();
  </script>
</body>
</html>
