<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SÃ©rie - OlimpÃ­ada IDB</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>OlimpÃ­ada IDB</h2>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Principal</div>
        <a href="dashboard.html" class="nav-item">
          <span class="nav-icon">ğŸ“Š</span>
          <span>Dashboard</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">OlimpÃ­adas</div>
        <a href="olimpiadas.html" class="nav-item">
          <span class="nav-icon">ğŸ…</span>
          <span>OlimpÃ­adas</span>
        </a>
        <a href="inscricoes.html" class="nav-item">
          <span class="nav-icon">ğŸ“</span>
          <span>InscriÃ§Ãµes</span>
        </a>
        <a href="resultados.html" class="nav-item">
          <span class="nav-icon">ğŸ“ˆ</span>
          <span>Resultados</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Cadastros</div>
        <a href="alunos.html" class="nav-item">
          <span class="nav-icon">ğŸ‘¥</span>
          <span>Alunos</span>
        </a>
        <a href="turmas.html" class="nav-item">
          <span class="nav-icon">ğŸ“</span>
          <span>Turmas</span>
        </a>
        <a href="series.html" class="nav-item active">
          <span class="nav-icon">ğŸ“š</span>
          <span>SÃ©ries</span>
        </a>
        <a href="anos-letivos.html" class="nav-item">
          <span class="nav-icon">ğŸ“…</span>
          <span>Anos Letivos</span>
        </a>
        <a href="filiais.html" class="nav-item">
          <span class="nav-icon">ğŸ«</span>
          <span>Filiais</span>
        </a>
        <a href="tipos-correcao.html" class="nav-item">
          <span class="nav-icon">âœ…</span>
          <span>Tipos de CorreÃ§Ã£o</span>
        </a>
        <a href="locais-aplicacao.html" class="nav-item">
          <span class="nav-icon">ğŸ“</span>
          <span>Locais de AplicaÃ§Ã£o</span>
        </a>
        <a href="tipos-pagamento.html" class="nav-item">
          <span class="nav-icon">ğŸ’°</span>
          <span>Tipos de Pagamento</span>
        </a>
      </div>

      <div class="nav-section" id="adminSection" style="display: none;">
        <div class="nav-section-title">AdministraÃ§Ã£o</div>
        <a href="usuarios.html" class="nav-item">
          <span class="nav-icon">ğŸ‘¤</span>
          <span>UsuÃ¡rios</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">RelatÃ³rios</div>
        <a href="medalhistas.html" class="nav-item">
          <span class="nav-icon">ğŸ¥‡</span>
          <span>Medalhistas</span>
        </a>
        <a href="rankings.html" class="nav-item">
          <span class="nav-icon">ğŸ“Š</span>
          <span>Rankings</span>
        </a>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <div class="main-wrapper">
    <!-- Topbar -->
    <header class="topbar">
      <div class="topbar-left">
        <h1 id="pageTitle">Nova SÃ©rie</h1>
      </div>
      <div class="topbar-right">
        <span class="user-name" id="userName">UsuÃ¡rio</span>
        <button class="btn btn-secondary btn-sm" onclick="logout()">Sair</button>
      </div>
    </header>

    <!-- Content -->
    <main class="main-content">
      <!-- Breadcrumb -->
      <div style="margin-bottom: 24px;">
        <nav style="display: flex; align-items: center; gap: 8px; color: rgba(0,0,0,0.6); font-size: 14px; font-family: Roboto, sans-serif;">
          <a href="series.html" style="color: #1976D2; text-decoration: none;">SÃ©ries</a>
          <span class="material-icons" style="font-size: 18px;">chevron_right</span>
          <span id="breadcrumbTitle">Nova SÃ©rie</span>
        </nav>
      </div>

      <!-- Form Card -->
      <div class="card" style="max-width: 800px; box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 8px 16px rgba(0,0,0,0.1);">
        <div class="card-header">
          <h2 style="margin: 0; font-size: 20px; font-weight: 500; font-family: Roboto, sans-serif; color: rgba(0,0,0,0.87);">
            <span id="formTitle">Dados da SÃ©rie</span>
          </h2>
        </div>
        <div class="card-body">
          <form id="formSerie" onsubmit="salvarSerie(event)" style="max-width: 600px;">
            <input type="hidden" id="idSerie">
            
            <!-- Campo Filial -->
            <div style="margin-bottom: 24px;">
              <label for="idFilial" style="display: block; margin-bottom: 8px; font-size: 14px; color: rgba(0,0,0,0.6); font-family: Roboto, sans-serif; font-weight: 500;">
                Filial *
              </label>
              <select 
                id="idFilial" 
                class="mdc-text-field__input" 
                required
                style="width: 100%; padding: 16px; border: 1px solid rgba(0,0,0,0.38); border-radius: 4px; font-size: 16px; font-family: Roboto, sans-serif; transition: border-color 0.2s; background: white;"
                onfocus="this.style.borderColor='#1976D2'; this.style.borderWidth='2px'; this.style.padding='15px'"
                onblur="this.style.borderColor='rgba(0,0,0,0.38)'; this.style.borderWidth='1px'; this.style.padding='16px'"
              >
                <option value="">Selecione uma filial</option>
              </select>
              <div style="margin-top: 4px; font-size: 12px; color: rgba(0,0,0,0.6); font-family: Roboto, sans-serif;">
                Unidade escolar Ã  qual a sÃ©rie pertence
              </div>
            </div>

            <!-- Campo CÃ³digo -->
            <div style="margin-bottom: 24px;">
              <label for="codSerie" style="display: block; margin-bottom: 8px; font-size: 14px; color: rgba(0,0,0,0.6); font-family: Roboto, sans-serif; font-weight: 500;">
                CÃ³digo da SÃ©rie *
              </label>
              <input 
                type="number" 
                id="codSerie" 
                class="mdc-text-field__input" 
                required 
                min="1"
                style="width: 100%; padding: 16px; border: 1px solid rgba(0,0,0,0.38); border-radius: 4px; font-size: 16px; font-family: Roboto, sans-serif; transition: border-color 0.2s;"
                onfocus="this.style.borderColor='#1976D2'; this.style.borderWidth='2px'; this.style.padding='15px'"
                onblur="this.style.borderColor='rgba(0,0,0,0.38)'; this.style.borderWidth='1px'; this.style.padding='16px'"
              >
              <div style="margin-top: 4px; font-size: 12px; color: rgba(0,0,0,0.6); font-family: Roboto, sans-serif;">
                CÃ³digo numÃ©rico Ãºnico para identificar a sÃ©rie
              </div>
            </div>

            <!-- Campo Nome -->
            <div style="margin-bottom: 24px;">
              <label for="nomeSerie" style="display: block; margin-bottom: 8px; font-size: 14px; color: rgba(0,0,0,0.6); font-family: Roboto, sans-serif; font-weight: 500;">
                Nome da SÃ©rie *
              </label>
              <input 
                type="text" 
                id="nomeSerie" 
                class="mdc-text-field__input" 
                required 
                maxlength="100"
                style="width: 100%; padding: 16px; border: 1px solid rgba(0,0,0,0.38); border-radius: 4px; font-size: 16px; font-family: Roboto, sans-serif; transition: border-color 0.2s;"
                onfocus="this.style.borderColor='#1976D2'; this.style.borderWidth='2px'; this.style.padding='15px'"
                onblur="this.style.borderColor='rgba(0,0,0,0.38)'; this.style.borderWidth='1px'; this.style.padding='16px'"
              >
              <div style="margin-top: 4px; font-size: 12px; color: rgba(0,0,0,0.6); font-family: Roboto, sans-serif;">
                Nome completo da sÃ©rie (ex: 1Âº Ano, 2Âº Ano)
              </div>
            </div>

            <!-- Campo AbreviaÃ§Ã£o -->
            <div style="margin-bottom: 32px;">
              <label for="abSerie" style="display: block; margin-bottom: 8px; font-size: 14px; color: rgba(0,0,0,0.6); font-family: Roboto, sans-serif; font-weight: 500;">
                AbreviaÃ§Ã£o *
              </label>
              <input 
                type="text" 
                id="abSerie" 
                class="mdc-text-field__input" 
                required 
                maxlength="10"
                style="width: 100%; padding: 16px; border: 1px solid rgba(0,0,0,0.38); border-radius: 4px; font-size: 16px; font-family: Roboto, sans-serif; transition: border-color 0.2s;"
                onfocus="this.style.borderColor='#1976D2'; this.style.borderWidth='2px'; this.style.padding='15px'"
                onblur="this.style.borderColor='rgba(0,0,0,0.38)'; this.style.borderWidth='1px'; this.style.padding='16px'"
              >
              <div style="margin-top: 4px; font-size: 12px; color: rgba(0,0,0,0.6); font-family: Roboto, sans-serif;">
                Sigla ou nome reduzido (mÃ¡ximo 10 caracteres)
              </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; padding-top: 24px; border-top: 1px solid rgba(0,0,0,0.12);">
              <button 
                type="button" 
                class="mdc-button mdc-button--outlined" 
                onclick="window.location.href='series.html'"
                style="padding: 10px 24px; border: 1px solid rgba(0,0,0,0.38); border-radius: 4px; background: transparent; color: #1976D2; font-family: Roboto, sans-serif; font-weight: 500; text-transform: uppercase; cursor: pointer; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.backgroundColor='rgba(25, 118, 210, 0.04)'"
                onmouseout="this.style.backgroundColor='transparent'"
              >
                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 8px;">arrow_back</span>
                Cancelar
              </button>
              <button 
                type="submit" 
                class="mdc-button mdc-button--raised" 
                style="padding: 10px 32px; border: none; border-radius: 4px; background: #1976D2; color: white; font-family: Roboto, sans-serif; font-weight: 500; text-transform: uppercase; cursor: pointer; font-size: 14px; box-shadow: 0 3px 1px -2px rgba(0,0,0,.2), 0 2px 2px 0 rgba(0,0,0,.14), 0 1px 5px 0 rgba(0,0,0,.12); transition: all 0.2s;"
                onmouseover="this.style.backgroundColor='#1565C0'; this.style.boxShadow='0 5px 5px -3px rgba(0,0,0,.2), 0 8px 10px 1px rgba(0,0,0,.14), 0 3px 14px 2px rgba(0,0,0,.12)'"
                onmouseout="this.style.backgroundColor='#1976D2'; this.style.boxShadow='0 3px 1px -2px rgba(0,0,0,.2), 0 2px 2px 0 rgba(0,0,0,.14), 0 1px 5px 0 rgba(0,0,0,.12)'"
              >
                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 8px;">save</span>
                Salvar
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <!-- Material Design JS -->
  <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
  
  <script src="../js/app.js"></script>
  <script>
    // Verificar autenticaÃ§Ã£o
    checkAuth();
    const user = getUser();
    if (user) {
      document.getElementById('userName').textContent = user.nome;
    }

    // Carregar filiais
    async function carregarFiliais() {
      try {
        const response = await fetchAuth('/filiais');
        const filiais = response.filiais || [];
        
        const select = document.getElementById('idFilial');
        filiais.forEach(filial => {
          const option = document.createElement('option');
          option.value = filial.idFilial;
          option.textContent = filial.filial;
          select.appendChild(option);
        });
      } catch (error) {
        showNotification('Erro ao carregar filiais: ' + error.message, 'error');
      }
    }

    // Verificar se estÃ¡ editando
    const urlParams = new URLSearchParams(window.location.search);
    const idSerie = urlParams.get('id');

    if (idSerie) {
      // Modo ediÃ§Ã£o
      document.getElementById('pageTitle').textContent = 'Editar SÃ©rie';
      document.getElementById('breadcrumbTitle').textContent = 'Editar SÃ©rie';
      document.getElementById('formTitle').textContent = 'Editar Dados da SÃ©rie';
      carregarFiliais().then(() => carregarSerie(idSerie));
    } else {
      carregarFiliais();
    }

    // Carregar dados da sÃ©rie para ediÃ§Ã£o
    async function carregarSerie(id) {
      try {
        const response = await fetchAuth(`/series/${id}`);
        const serie = response.serie;
        
        document.getElementById('idSerie').value = serie.idSerie;
        document.getElementById('idFilial').value = serie.idFilial;
        document.getElementById('codSerie').value = serie.codSerie;
        document.getElementById('nomeSerie').value = serie.serie;
        document.getElementById('abSerie').value = serie.abSerie;
      } catch (error) {
        showNotification('Erro ao carregar sÃ©rie: ' + error.message, 'error');
        setTimeout(() => window.location.href = 'series.html', 2000);
      }
    }

    // Salvar sÃ©rie (criar ou atualizar)
    async function salvarSerie(event) {
      event.preventDefault();
      
      const idSerie = document.getElementById('idSerie').value;
      const dados = {
        idFilial: parseInt(document.getElementById('idFilial').value),
        codSerie: parseInt(document.getElementById('codSerie').value),
        serie: document.getElementById('nomeSerie').value.trim(),
        abSerie: document.getElementById('abSerie').value.trim()
      };

      try {
        if (idSerie) {
          // Atualizar
          await fetchAuth(`/series/${idSerie}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
          });
          showNotification('SÃ©rie atualizada com sucesso!', 'success');
        } else {
          // Criar
          await fetchAuth(`/series`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
          });
          showNotification('SÃ©rie criada com sucesso!', 'success');
        }
        
        setTimeout(() => window.location.href = 'series.html', 1500);
      } catch (error) {
        showNotification('Erro ao salvar sÃ©rie: ' + error.message, 'error');
      }
    }
  </script>
</body>
</html>
