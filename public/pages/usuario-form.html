<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formul√°rio de Usu√°rio - Olimp√≠ada IDB</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="dashboard.html" class="sidebar-logo">
          <div class="sidebar-logo-icon">üèÜ</div>
          <span>Olimp√≠ada IDB</span>
        </a>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>
          <a href="dashboard.html" class="nav-item">
            <span class="nav-icon">üìä</span>
            <span>Dashboard</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Olimp√≠adas</div>
          <a href="olimpiadas.html" class="nav-item">
            <span class="nav-icon">üèÖ</span>
            <span>Olimp√≠adas</span>
          </a>
          <a href="inscricoes.html" class="nav-item">
            <span class="nav-icon">üìù</span>
            <span>Inscri√ß√µes</span>
          </a>
          <a href="resultados.html" class="nav-item">
            <span class="nav-icon">üìà</span>
            <span>Resultados</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Cadastros</div>
          <a href="alunos.html" class="nav-item">
            <span class="nav-icon">üë•</span>
            <span>Alunos</span>
          </a>
          <a href="turmas.html" class="nav-item">
            <span class="nav-icon">üéì</span>
            <span>Turmas</span>
          </a>
          <a href="series.html" class="nav-item">
            <span class="nav-icon">üìö</span>
            <span>S√©ries</span>
          </a>
          <a href="anos-letivos.html" class="nav-item">
            <span class="nav-icon">üìÖ</span>
            <span>Anos Letivos</span>
          </a>
          <a href="filiais.html" class="nav-item">
            <span class="nav-icon">üè´</span>
            <span>Filiais</span>
          </a>
          <a href="tipos-correcao.html" class="nav-item">
            <span class="nav-icon">‚úÖ</span>
            <span>Tipos de Corre√ß√£o</span>
          </a>
          <a href="locais-aplicacao.html" class="nav-item">
            <span class="nav-icon">üìç</span>
            <span>Locais de Aplica√ß√£o</span>
          </a>
          <a href="tipos-pagamento.html" class="nav-item">
            <span class="nav-icon">üí∞</span>
            <span>Tipos de Pagamento</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Relat√≥rios</div>
          <a href="medalhistas.html" class="nav-item">
            <span class="nav-icon">ü•á</span>
            <span>Medalhistas</span>
          </a>
          <a href="rankings.html" class="nav-item">
            <span class="nav-icon">üìä</span>
            <span>Rankings</span>
          </a>
        </div>

        <div class="nav-section" id="adminSection" style="display: none;">
          <div class="nav-section-title">Administra√ß√£o</div>
          <a href="usuarios.html" class="nav-item active">
            <span class="nav-icon">üë§</span>
            <span>Usu√°rios</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Topbar -->
      <header class="topbar">
        <div class="topbar-left">
          <button class="btn btn-secondary btn-sm" onclick="window.location.href='usuarios.html'">
            <span class="material-icons">arrow_back</span>
            Voltar
          </button>
          <h1 class="page-title" id="pageTitle">Novo Usu√°rio</h1>
        </div>
        <div class="topbar-right">
          <span class="topbar-user" id="userName">Carregando...</span>
          <button class="btn btn-secondary btn-sm" onclick="logout()">Sair</button>
        </div>
      </header>

      <!-- Content -->
      <div class="content">
        <div class="form-container">
          <div class="card">
            <div class="card-header">
              <h3 id="formTitle">Novo Usu√°rio</h3>
            </div>
            <div class="card-body">
              <form id="usuarioForm" onsubmit="handleSubmit(event)">
                <div class="form-grid">
                  <div class="form-group" style="grid-column: span 2;">
                    <label for="nome_completo" class="form-label required">Nome Completo</label>
                    <input type="text" id="nome_completo" class="input" required minlength="3" maxlength="150">
                  </div>

                  <div class="form-group">
                    <label for="email" class="form-label required">Email</label>
                    <input type="email" id="email" class="input" required>
                  </div>

                  <div class="form-group">
                    <label for="cpf" class="form-label">CPF</label>
                    <input type="text" id="cpf" class="input" maxlength="14" placeholder="000.000.000-00">
                  </div>

                  <div class="form-group">
                    <label for="telefone" class="form-label">Telefone</label>
                    <input type="text" id="telefone" class="input" maxlength="15" placeholder="(00) 00000-0000">
                  </div>

                  <div class="form-group">
                    <label for="id_perfil" class="form-label required">Perfil</label>
                    <select id="id_perfil" class="input" required>
                      <option value="">Selecione...</option>
                      <option value="1">Administrador</option>
                      <option value="2">Coordenador</option>
                      <option value="3">Professor</option>
                      <option value="4">Visualizador</option>
                    </select>
                  </div>

                  <div class="form-group" id="senhaGroup">
                    <label for="senha" class="form-label required">Senha</label>
                    <input type="password" id="senha" class="input" minlength="6">
                    <small class="form-hint">M√≠nimo 6 caracteres</small>
                  </div>

                  <div class="form-group" id="confirmarSenhaGroup">
                    <label for="confirmarSenha" class="form-label required">Confirmar Senha</label>
                    <input type="password" id="confirmarSenha" class="input" minlength="6">
                  </div>

                  <div class="form-group">
                    <label class="form-label">Status</label>
                    <div class="checkbox-group">
                      <label class="checkbox-label">
                        <input type="checkbox" id="ativo" checked>
                        <span>Usu√°rio Ativo</span>
                      </label>
                    </div>
                  </div>
                </div>

                <div class="form-actions">
                  <button type="button" class="btn btn-secondary" onclick="window.location.href='usuarios.html'">Cancelar</button>
                  <button type="submit" class="btn btn-primary" id="submitBtn">Salvar Usu√°rio</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../js/app.js"></script>
  <script>
    checkAuth();
    
    const user = getUser();
    if (user) {
      document.getElementById('userName').textContent = user.nome || user.email;
      
      // Verificar se √© administrador
      if (user.nivel_acesso === 1) {
        document.getElementById('adminSection').style.display = 'block';
      } else {
        showNotification('Acesso negado. Apenas administradores podem acessar esta p√°gina.', 'error');
        setTimeout(() => {
          window.location.href = 'dashboard.html';
        }, 2000);
      }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const usuarioId = urlParams.get('id');
    let isEditMode = !!usuarioId;

    if (isEditMode) {
      document.getElementById('pageTitle').textContent = 'Editar Usu√°rio';
      document.getElementById('formTitle').textContent = 'Editar Usu√°rio';
      document.getElementById('submitBtn').textContent = 'Atualizar Usu√°rio';
      
      // No modo de edi√ß√£o, senha √© opcional
      document.getElementById('senha').removeAttribute('required');
      document.getElementById('confirmarSenha').removeAttribute('required');
      document.querySelector('#senhaGroup .form-label').classList.remove('required');
      document.querySelector('#confirmarSenhaGroup .form-label').classList.remove('required');
      document.querySelector('#senhaGroup small').textContent = 'Deixe em branco para manter a senha atual';
      
      loadUsuario(usuarioId);
    }

    // M√°scaras
    document.getElementById('cpf').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length <= 11) {
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        e.target.value = value;
      }
    });

    document.getElementById('telefone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length <= 11) {
        if (value.length <= 10) {
          value = value.replace(/(\d{2})(\d)/, '($1) $2');
          value = value.replace(/(\d{4})(\d)/, '$1-$2');
        } else {
          value = value.replace(/(\d{2})(\d)/, '($1) $2');
          value = value.replace(/(\d{5})(\d)/, '$1-$2');
        }
        e.target.value = value;
      }
    });

    async function loadUsuario(id) {
      try {
        const response = await fetchAuth(`/usuarios/${id}`);
        const usuario = response.data;

        document.getElementById('nome_completo').value = usuario.nome_completo || '';
        document.getElementById('email').value = usuario.email || '';
        document.getElementById('cpf').value = usuario.cpf ? formatCPF(usuario.cpf) : '';
        document.getElementById('telefone').value = usuario.telefone ? formatTelefone(usuario.telefone) : '';
        document.getElementById('id_perfil').value = usuario.id_perfil || '';
        document.getElementById('ativo').checked = usuario.ativo;

      } catch (error) {
        console.error('Erro ao carregar usu√°rio:', error);
        showNotification('Erro ao carregar usu√°rio', 'error');
        setTimeout(() => {
          window.location.href = 'usuarios.html';
        }, 2000);
      }
    }

    async function handleSubmit(event) {
      event.preventDefault();

      const senha = document.getElementById('senha').value;
      const confirmarSenha = document.getElementById('confirmarSenha').value;

      // Validar senhas se estiverem preenchidas
      if (senha || confirmarSenha) {
        if (senha !== confirmarSenha) {
          showNotification('As senhas n√£o coincidem', 'error');
          return;
        }
      }

      const formData = {
        nome_completo: document.getElementById('nome_completo').value,
        email: document.getElementById('email').value,
        cpf: document.getElementById('cpf').value.replace(/\D/g, '') || null,
        telefone: document.getElementById('telefone').value.replace(/\D/g, '') || null,
        id_perfil: parseInt(document.getElementById('id_perfil').value),
        ativo: document.getElementById('ativo').checked
      };

      // Adicionar senha apenas se foi preenchida
      if (senha) {
        formData.senha = senha;
      }

      try {
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').textContent = 'Salvando...';

        if (isEditMode) {
          await fetchAuth(`/usuarios/${usuarioId}`, {
            method: 'PUT',
            body: JSON.stringify(formData)
          });
          showNotification('Usu√°rio atualizado com sucesso!', 'success');
        } else {
          if (!senha) {
            showNotification('Senha √© obrigat√≥ria para novos usu√°rios', 'error');
            return;
          }
          await fetchAuth('/usuarios', {
            method: 'POST',
            body: JSON.stringify(formData)
          });
          showNotification('Usu√°rio criado com sucesso!', 'success');
        }

        setTimeout(() => {
          window.location.href = 'usuarios.html';
        }, 1500);

      } catch (error) {
        console.error('Erro ao salvar usu√°rio:', error);
        showNotification(error.message || 'Erro ao salvar usu√°rio', 'error');
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').textContent = isEditMode ? 'Atualizar Usu√°rio' : 'Salvar Usu√°rio';
      }
    }

    function formatCPF(cpf) {
      return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }

    function formatTelefone(tel) {
      if (tel.length === 10) {
        return tel.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
      } else if (tel.length === 11) {
        return tel.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
      }
      return tel;
    }
  </script>
</body>
</html>
